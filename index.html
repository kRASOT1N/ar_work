<!DOCTYPE html>
<html lang="pl">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-touch-fullscreen" content="yes">
    <title>Przeglądarka AR</title>
    
    <!-- A-Frame и AR.js -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
    
    <style>
      body, html {
        margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden;
        background-color: #000; color: #fff; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      }
      #loading-screen {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.8); display: flex;
        flex-direction: column; justify-content: center; align-items: center;
        z-index: 9999;
      }
      #loading-screen.hidden { display: none; }
      #loading-text { font-size: 18px; margin-top: 10px; }
      #marker-status {
        position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
        background: rgba(0,0,0,0.7); padding: 10px 20px; border-radius: 20px;
        font-size: 16px; z-index: 1000; display: none;
      }
      .model-nav-buttons {
        position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
        display: flex; gap: 30px; z-index: 1000;
      }
      .nav-button {
        width: 60px; height: 60px; cursor: pointer;
        transition: transform 0.2s;
      }
      .nav-button:hover { transform: scale(1.1); }
      .nav-button:active { transform: scale(0.95); }
      .a-enter-vr { display: none !important; }
    </style>
  </head>
  <body>
    <!-- Экран загрузки -->
    <div id="loading-screen">
      <div class="spinner"></div>
      <div id="loading-text">Ładowanie modelu...</div>
    </div>

    <!-- Статус маркера -->
    <div id="marker-status">Nakieruj kamerę na marker Hiro</div>

    <!-- Кнопки навигации между моделями -->
    <div class="model-nav-buttons">
      <img id="btn-left" src="L.png" class="nav-button" alt="Poprzedni model">
      <img id="btn-right" src="R.png" class="nav-button" alt="Następny model">
    </div>

    <a-scene
      embedded
      arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono; trackingMethod: best; maxDetectionRate: 60;"
      renderer="logarithmicDepthBuffer: true; precision: medium;"
      vr-mode-ui="enabled: false"
    >
      <a-assets>
        <!-- опциональный спин для моделей -->
        <a-mixin id="spin" animation="property: rotation; to: 0 360 0; loop: true; dur: 10000; easing: linear"></a-mixin>
      </a-assets>

      <!-- Hiro-маркер -->
      <a-marker
        id="hiro-marker"
        type="pattern" preset="hiro"
        smooth="true" smoothCount="10" smoothTolerance="0.01" smoothThreshold="2"
        minConfidence="0.15"
        raycaster="objects: .clickable"
        emitevents="true"
      >
        <!-- Контейнер модели: теперь на 0 0 0 -->
        <a-entity id="model-wrapper" position="0 0 0">
          <a-entity
            id="model-container"
            rotation="0 0 0"
            scale="1 1 1"
            center-pivot
            model-orientation
            model-stabilizer
          ></a-entity>
        </a-entity>

        <!-- Кнопки внутри сцены (ссылки) -->
        <a-entity position="0 0.75 0">
          <a-plane
            id="website-button"
            position="1.2 0 0"
            rotation="0 0 0"
            width="0.5" height="0.5"
            material="src: site.png; transparent: true;"
            look-at="[camera]"
            class="clickable"
            animation__click="property: scale; from: 1 1 1; to: 0.9 0.9 0.9; dur: 100; easing: easeInOutQuad; startEvents: click"
            animation__clickback="property: scale; from: 0.9 0.9 0.9; to: 1 1 1; dur: 100; easing: easeInOutQuad; startEvents: animationcomplete__click"
          ></a-plane>
          <a-plane
            id="email-button"
            position="-1.2 0 0"
            rotation="0 0 0"
            width="0.5" height="0.5"
            material="src: em.png; transparent: true;"
            look-at="[camera]"
            class="clickable"
            animation__click="property: scale; from: 1 1 1; to: 0.9 0.9 0.9; dur: 100; easing: easeInOutQuad; startEvents: click"
            animation__clickback="property: scale; from: 0.9 0.9 0.9; to: 1 1 1; dur: 100; easing: easeInOutQuad; startEvents: animationcomplete__click"
          ></a-plane>
        </a-entity>
      </a-marker>

      <!-- Камера и курсор -->
      <a-entity camera>
        <a-cursor raycaster="objects: .clickable"></a-cursor>
      </a-entity>
    </a-scene>

    <script>
      // Отключаем стандартные диалоги AR.js
      window.addEventListener('load', () => {
        if (window.ARjs && window.ARjs.Utils) window.ARjs.Utils.displayResolutionPrompt = () => {};
        window.confirm = () => true;
        window.prompt  = (_m, d) => d;
      });

      // Центрируем pivot модели по её геометрии
      AFRAME.registerComponent('center-pivot', {
        init: function() {
          this.el.addEventListener('model-loaded', () => {
            const obj = this.el.getObject3D('mesh') || this.el.getObject3D('scene');
            if (!obj) return;
            const box = new THREE.Box3().setFromObject(obj);
            const center = box.getCenter(new THREE.Vector3());
            this.el.object3D.position.y -= center.y;
          });
        }
      });

      // Повторяем всю ориентацию маркера (без ограничений)
      AFRAME.registerComponent('model-orientation', {
        tick: function() {
          const marker = document.querySelector('#hiro-marker');
          if (marker && marker.object3D.visible) {
            this.el.object3D.quaternion.copy(marker.object3D.quaternion);
          }
        }
      });

      // Простая стабилизация позиции
      AFRAME.registerComponent('model-stabilizer', {
        init: function() {
          this.lastPos = new THREE.Vector3();
          this.factor  = 0.3;
        },
        tick: function() {
          const pos = this.el.object3D.position;
          pos.lerp(this.lastPos, 1 - this.factor);
          this.lastPos.copy(pos);
        }
      });

      // Обработка кликов по ссылкам
      AFRAME.registerComponent('clickable', {
        init: function() {
          this.el.addEventListener('click', () => {
            if (this.el.id === 'website-button') {
              window.open('https://www.alphawood.store', '_blank');
            }
            if (this.el.id === 'email-button') {
              window.location.href = 'mailto:info@alphawood.store';
            }
          });
        }
      });

      // Модели и навигация
      const models = [
        { glb: 'models/cat.glb',   scale: '3 3 3' },
        { glb: 'models/model.glb', scale: '3 3 3' }
      ];
      let currentIndex = 0, currentModel = null;
      const container = document.querySelector('#model-container');
      const loadScreen = document.getElementById('loading-screen');
      const loadText   = document.getElementById('loading-text');
      const mStatus    = document.getElementById('marker-status');

      function showLoading(msg='Ładowanie modelu...') {
        loadText.textContent = msg;
        loadScreen.classList.remove('hidden');
      }
      function hideLoading() {
        loadScreen.classList.add('hidden');
      }

      function switchModel(delta) {
        currentIndex = (currentIndex + delta + models.length) % models.length;
        const m = models[currentIndex];
        loadModel(m.glb, m.scale, false);
      }

      function loadModel(path, scale, initial) {
        if (initial) showLoading();
        if (currentModel) currentModel.remove();
        currentModel = document.createElement('a-entity');
        currentModel.setAttribute('gltf-model', path);
        currentModel.setAttribute('scale', scale);
        // currentModel.setAttribute('mixin', 'spin'); // если нужен авто-спин
        container.appendChild(currentModel);
        currentModel.addEventListener('model-loaded', () => {
          if (initial) hideLoading();
        });
        currentModel.addEventListener('model-error', () => {
          if (initial) {
            loadText.textContent = 'Błąd ładowania';
            setTimeout(hideLoading, 2000);
          }
          console.error('Error loading', path);
        });
      }

      document.getElementById('btn-left').addEventListener('click',  () => switchModel(-1));
      document.getElementById('btn-right').addEventListener('click', () => switchModel( 1));

      document.addEventListener('DOMContentLoaded', async () => {
        if (navigator.xr) {
          const ok = await navigator.xr.isSessionSupported('immersive-ar');
          if (!ok) console.log('WebXR AR unsupported; fallback to AR.js');
        }
        loadModel(models[0].glb, models[0].scale, true);
      });

      // Показать/скрыть статус маркера
      const marker = document.querySelector('#hiro-marker');
      marker.addEventListener('markerFound', () => mStatus.style.display = 'none');
      marker.addEventListener('markerLost',  () => mStatus.style.display = 'block');
    </script>
  </body>
</html>
